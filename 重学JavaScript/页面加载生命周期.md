# 页面生命周期

HTML 页面加载时的生命周期分为以下三个重要事件：

* DOMContentLoaded——浏览器已加载 HTML，并构建 DOM 树，但css之类的外部资源可能没加载完成。(此时可以访问DOM 节点)
* load——浏览器不仅加载完成HTML，还加载完成了所有外部资源：图片、样式等。(此时外部资源全部加载完成,可以获取样式、大小等)
* beforeunload/unload——用户正在离开页面时。(我们可以询问用户是否已保存)
* unload——用户几乎已经离开了。(依然可以启动一些操作，比如发送统计数据等)

# DOMContentLoaded

我们可以通过`document`来监听`DOMContentLoaded`事件

```html
<script>
  function ready() {
    alert('DOM is ready');

    // 图片目前尚未加载完成（除非已经被缓存），所以图片的大小为 0x0
    alert(`Image size: ${img.offsetWidth}x${img.offsetHeight}`);
  }

  document.addEventListener("DOMContentLoaded", ready);
</script>

<img id="img" src="https://en.js.cx/clipart/train.gif?speed=1&cache=0">
```

`DOMContentLoaded`在文档加载完就触发了,此时由于 img 图片并没有被获取到(外部资源没有加载完成),而仅仅只能获取到 DOM 接口,所以上面的代码并不能打印出 img的大小。

`DOMContentLoaded`的逻辑非常简单:不等外部样式,而是 DOM 树构建完成就触发。

但是事实并非如此简单，我们在实际开发中不可能保证DOM 树构建完成而外部资源没有获取吧？以下介绍一些细节：

## DOMContentLoaded触发条件细节

### DOMContentLoaded和 script

当浏览器处理一个 HTML 文档，并在文档中遇到 `<script>` 标签时，就会在继续构建 DOM 之前运行它。

这是因为 script 内的代码可能会修改 DOM,所以必须先运行它。

而`DOMContentLoaded`是在构建完 DOM 树之后才会启动的事件,所以DOMContentLoaded肯定会等以下脚本全部加载完成后才执行:

```html
<script>
  document.addEventListener("DOMContentLoaded", () => {
    alert("DOM ready!");
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js"></script>

<script>
  alert("Library loaded, inline script executed");
</script>
```

在上面的例子中,一定是先打印"Library loaded, inline script executed"这句话,才会打印"DOM ready!"

> 这个规则有两个例外:
>
> 1.当 script 有 async 属性
>
> 2.script 是由document.createElement('script')动态生成并加入到网页中时
>
> DOMContentLoaded会提前生效,不会被阻塞

### DOMContentLoaded和外部样式

外部样式表不会影响 DOM，因此 `DOMContentLoaded` 不会等待它们。

但这里有一个陷阱。如果在样式后面有一个脚本，那么该脚本必须等待样式表加载完成：

```html
<link type="text/css" rel="stylesheet" href="style.css">
<script>
  // 在样式表加载完成之前，脚本都不会执行
  alert(getComputedStyle(document.body).marginTop);
</script>
```

这是因为浏览器是自上而下解析并执行的,当遇到 link 时,就会去解析外部样式文件,然后再执行 script 标签内的代码。

当 script 标签在等样式表加载完成时，DOMContentLoaded等 script 标签加载完。

所以`DOMContentLoaded`也会等待外部资源加载完成,对吧?

## DOMContentLoaded的应用

Firefox，Chrome 和 Opera 都会在 `DOMContentLoaded` 中自动填充表单。

例如，如果页面有一个带有登录名和密码的表单，并且浏览器记住了这些值，那么在 `DOMContentLoaded` 上，浏览器会尝试自动填充它们（如果得到了用户允许）。

因此，如果 `DOMContentLoaded` 被需要加载很长时间的脚本延迟触发，那么自动填充也会等待。

